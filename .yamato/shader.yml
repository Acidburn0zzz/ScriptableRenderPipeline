tests:
  - name: CI-Tools Test Windows
    os: win
    type: Unity::VM::GPU
    image: sdet/gamecode_win10:latest
    flavor: b1.medium
modes:
  - editmode
editorrevisions:
  - name: 2018.3-release
    revision: 16c3bea1c6ed29f744ff45874e9123f019d96785
#Foldername of the different projects to test on a single run
projects:
  - VisualEffectGraph
---
{% for test in tests %}
{% for editor in editorrevisions %}
{% for mode in modes %}
shadergraph_test_{{ mode }}:
  name: shadergraph_test - {{ mode }}
  agent:
    type: {{ test.type }}
    image: {{ test.image }}
    flavor: {{ test.flavor }}
  commands:
    # PRE-STEP COMMANDS SHOULD GO AFTER THIS LINE
    # END OF PRE-STEP COMMANDS SECTION
    #THE FOLLOWING LINES ARE FOR PACKAGE INFRASTRUCTURE SETUP AND TOOLS
    # Install ci tools dependencies
    - npm install upm-ci-utils -g --registry https://api.bintray.com/npm/unity/unity-npm
    {% for project in projects %}
    - upm-ci project test {{ test.os }} {{ editor.revision }} --custom-cmd "powershell.exe .Editor/Unity.exe -batchmode -projectPath TestProjects/{{ project }} -automated -testresults ../automation/test-results/testresults_{{ mode }}_{{ project }}.xml -logfile ./automation/logs/log_{{ mode }}_{{ project }}.log -runtests -silentcrashes -testplatform {{ mode }}
    {% endfor %}
    # END OF PACKAGE INFRASTRUCTURE STEPS
    # POST-STEP COMMANDS SHOULD GO HERE
    # E.G.: Modify packages inside the Packages folder before calling the package pack command
    #END OF POST-STEP COMMANDS SECTION
    #THE FOLLOWING LINE CREATES THE TGZ FOR PACKAGES INSIDE THE SPECIFIED PATH
  artifacts:
    logs.zip:
      paths:
        - "automation/logs/**"
    test-results.zip:
      paths:
        - "automation/test-results/**"
{% endfor %}
{% endfor %}
{% endfor %}

build_packages:
  name: Build Packages
  agent:
    type: Unity::VM
    image: sdet/gamecode_win10:v0.1.0-539067
    flavor: b1.small
  commands:
    # Install ci tools dependencies
    - npm install upm-ci-utils -g --registry https://api.bintray.com/npm/unity/unity-npm
    - upm-ci project pack --artifacts-path .
  artifacts:
    packages.zip:
      paths:
        - "*.tgz"
  dependencies:
    {% for test in tests %}
    {% for editor in editorrevisions %}
    {% for mode in modes %}
    - .yamato/ci.yml#{{ test.os }}_{{ editor.name }}_{{ mode }}
    {% endfor %}
    {% endfor %}
    {% endfor %}